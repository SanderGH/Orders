<!DOCTYPE html>
<html>
<head>
    <script src="jquery-3.2.1.js"></script>
    <script src="lodash.js"></script>
    <script src="knockout-3.4.2.js"></script>
    <script src="Chart.js"></script>
</head>
<body>
    <script>
        // model
        orders = _.map( JSON.parse(localStorage.getItem("OrdersSC") ), function( value, key, coll ) {
            map = new Map();
            //items = _.map(this.filtered_orders(), 'items');
            _.forEach(value.items, function (item) {
                    if (map.has(item.code) == false)
                        map.set(item.code, { 'name': item.name, 'quantity': Number(item.quantity), 'sum': Number(item.quantity) * Number(item.price) })
                    else {
                        ss = map.get(item.code);
                        ss.quantity += Number(item.quantity);
                        ss.sum += Number(item.quantity) * Number(item.price);
                    }
            });
            
            newItems = [];
            map.forEach( function(obj) {
                 newItems.push(obj); 
            });
            
            newOrder =  {
                user_id: value.user_id,
                create_date: value.create_date,
                sum: value.sum,
                delivery_sum: value.delivery_sum,
                merchant: value.merchant,
                delivery: value.delivery,
                transport: value.transport,
                city: value.city,
                coupon_code: value.coupon_code,
                status_name: value.status_name,
                cancel_reason: value.cancel_reason,
                isnew_user: value.isnew_user,
                orders_count: value.orders_count,
                items: newItems
                }
            return newOrder;} );

        // create viewModel
        function OrdersViewModel()
        {
            this.OrdersClosed = _.reject( orders, { status_name: "Отменен" } );
            this.orders_canceled = _.filter( orders, { status_name: "Отменен" });           

            moscow_region = JSON.parse(localStorage.getItem("cities"));

            orders_closed = _.reject(orders, { status_name: "Отменен" });
            orders_canceled = _.filter(orders, { status_name: "Отменен" });

            moscow = _.filter(orders_closed, { city: 'Москва' });
            moscow_sum = _.sumBy(moscow, function (obj) { return Number(obj.sum) });

            ViewModel = {
                brands: ko.observableArray(
                    _.map(
                        _.uniq(_.map(orders_closed, 'brand_name')), function (entry) {
                            return { "name": entry, "visible": false };
                        }
                    )
                ),

                cities: ko.observableArray(_.map(
                        _.uniq(_.map(orders_closed, 'city')), function (entry) {
                            check = (moscow_region.indexOf(entry) != -1);
                            return { "name": entry, "visible": check };
                        }
                    )
                ),

                goods: ko.observableArray(),

                choose_cities: ko.observableArray(_.filter(cities, 'visible')),

                filtered_orders: ko.observableArray(_.filter(orders_closed, { 'city': '' })),



                changeCities: function () {
                    this.choose_cities(_.map(_.filter(this.cities(), 'visible'), 'name'));

                    var sss = this.choose_cities();
                    this.filtered_orders(_.filter(orders_closed, function (entry) {
                        return sss.indexOf(entry.city) != -1
                    }));

                    map = new Map();
                    items = _.map(this.filtered_orders(), 'items');
                    _.forEach(items, function (item) {
                        _.forEach(item, function (row) {
                            if (map.has(row.code) == false)
                                map.set(row.code, { 'name': row.name, 'quantity': Number(row.quantity), 'sum': Number(row.quantity) * Number(row.price) })
                            else {
                                ss = map.get(row.code);
                                ss.quantity += Number(row.quantity);
                                ss.sum += Number(row.quantity) * Number(row.price);
                            }
                        })
                    });
                    map.forEach(function (obj) {
                        ViewModel.goods.push(obj);
                    });
                }



            };             
        }

        ko.applyBindings( new OrdersViewModel() );
        /*_.map( ViewModel.filtered_orders(), function(order){ console.log(order.create_date);
            var createDate = new Date(Number(order.create_date)*1000); console.log(createDate);console.log("" + createDate.getMonth() + " " + createDate.getFullYear());
            order.create_date = "" + createDate.getMonth() + " " + createDate.getFullYear();
            console.log(order);
        })
        
        ddd = _.map( ViewModel.filtered_orders(), function(order){ console.log(order.create_date);
        var createDate = new Date(Number(order.create_date)*1000); console.log(createDate);console.log("" + createDate.getMonth() + " " + createDate.getFullYear());
        order.create_date = "" + createDate.getMonth() + " " + createDate.getFullYear();
        console.log(order); return order;

        _.groupBy(ddd, 'create_date')
 })
        
        
        */

        /*     _.transform(items, function (result, entry) {
                 console.log(entry);
                 qqq = _.map(entry);
                 console.log(qqq);
                 /*items.foreach(function (item, index, arr) {
                     var newObj =
                         {
                             'code' : item.code
                         }
                         console.log(newObj);
                 })
             })*/
    </script>
    <script>
        function drawChart() {
            var ctx = document.getElementById('myChart');
            //ctx.height = 130;
            var chart = new Chart(ctx, {
                // The type of chart we want to create
                type: 'bubble',

                // The data for our dataset
                data: {
                    labels: ["January", "February", "March", "April", "May", "June", "July"],
                    datasets: [{
                        label: "My First dataset",
                        backgroundColor: 'rgb(255, 99, 132)',
                        borderColor: 'rgb(255, 99, 132)',
                        data: [0, 10, 5, 2, 20, 30, 45],
                    }]
                },

                // Configuration options go here
                options: {}
            });
        }
    </script>

    <div>
        <a href="#" onclick="loadReports()">Загрузить данные</a>
        <a href="#" onclick="drawChart()">Диаграмма</a>
        <div width="300" height="150">
            <canvas id="myChart"></canvas>
        </div>

        <div id="cities">
            <ul data-bind="foreach: { data: cities, as: 'city'}">
                <li>
                    <input type="checkbox" data-bind="checked: city.visible, event: { change : $parent.changeCities.bind($parent) }" />
                    <span data-bind="text: city.name" />
                </li>
            </ul>
        </div>

        <div id="brands">
            <ul data-bind="foreach: { data: brands, as: 'brand'}">
                <li>
                    <input type="checkbox" data-bind="checked: brand.visible" />
                    <span data-bind="text: brand.name" />
                </li>
            </ul>
        </div>

        <div id="orders_closed"></div>
        <div id="orders_canceled"></div>
    </div>
    <table>
        <tbody data-bind="foreach: goods">
            <tr>
                <td data-bind="text: name"></td>
                <td data-bind="text: quantity"></td>
                <td data-bind="text: sum"></td>
            </tr>
        </tbody>
    </table>
</body>
</html>